<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings • RealSports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav class="site-nav">
    <div class="brand">
        <span class="badge">RealSports</span>
        <strong>Picks Hub</strong>
    </div>
    <div class="nav-links">
        <a href="/picks/test2">Picks</a>
        <a href="/picks/cbb">CBB</a>
        <a class="active" href="/settings">Settings</a>
    </div>
</nav>
<main class="layout settings-page">
    <header class="page-header">
        <div class="title-block">
            <p class="eyebrow">Automation</p>
            <h1>Background jobs & utilities</h1>
            <p>Daily runs happen at 5 AM ET. Use these controls only when you need to rerun something manually.</p>
        </div>
        <div class="control-panel">
            <p class="muted">Full pipeline</p>
            <div class="control-actions">
                <button class="btn primary" data-run-pipeline type="button">Run Full Pipeline</button>
                <a class="btn ghost" href="/settings/jobs">View job status</a>
            </div>
            <p class="meta" id="pipeline-status" aria-live="polite" hidden>Pipeline status…</p>
            <ul class="pipeline-log" id="pipeline-log" hidden></ul>
        </div>
    </header>
    <div class="status" id="status-banner" hidden></div>

    <section class="settings-grid">
        <article class="info-card job-controls">
            <h3>Manual runs</h3>
            {% set runtime = job_runtime or {} %}
            <div class="job-control">
                <button class="btn ghost" data-run-job="schedule_fetch" type="button">Run Schedule Fetch</button>
                {% set state = runtime.get("schedule_fetch") %}
                <p class="meta" data-job-status="schedule_fetch" {% if not (state and (state.running or state.last_error)) %}hidden{% endif %}>
                    {% if state %}
                        {% if state.running %}
                            {{ state.last_message or "Running…" }}
                        {% elif state.last_error %}
                            Error: {{ state.last_error }}
                        {% endif %}
                    {% endif %}
                </p>
                <ul class="pipeline-log" data-job-log="schedule_fetch" {% if not state or not state.running %}hidden{% endif %}>
                    {% if state and state.log %}
                        {% for entry in state.log[:5] %}
                            <li><span>{{ entry.timestamp }}</span> — {{ entry.message }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="job-control">
                <button class="btn ghost" data-run-job="injuries" type="button">Run Injuries Cache</button>
                {% set state = runtime.get("injuries") %}
                <p class="meta" data-job-status="injuries" {% if not (state and (state.running or state.last_error)) %}hidden{% endif %}>
                    {% if state %}
                        {% if state.running %}
                            {{ state.last_message or "Running…" }}
                        {% elif state.last_error %}
                            Error: {{ state.last_error }}
                        {% endif %}
                    {% endif %}
                </p>
                <ul class="pipeline-log" data-job-log="injuries" {% if not state or not state.running %}hidden{% endif %}>
                    {% if state and state.log %}
                        {% for entry in state.log[:5] %}
                            <li><span>{{ entry.timestamp }}</span> — {{ entry.message }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="job-control">
                <button class="btn ghost" data-run-job="cbb_scraper" type="button">Run CBB Scraper</button>
                {% set state = runtime.get("cbb_scraper") %}
                <p class="meta" data-job-status="cbb_scraper" {% if not (state and (state.running or state.last_error)) %}hidden{% endif %}>
                    {% if state %}
                        {% if state.running %}
                            {{ state.last_message or "Running…" }}
                        {% elif state.last_error %}
                            Error: {{ state.last_error }}
                        {% endif %}
                    {% endif %}
                </p>
                <ul class="pipeline-log" data-job-log="cbb_scraper" {% if not state or not state.running %}hidden{% endif %}>
                    {% if state and state.log %}
                        {% for entry in state.log[:5] %}
                            <li><span>{{ entry.timestamp }}</span> — {{ entry.message }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="job-control">
                <button class="btn ghost" data-refresh-test2-all type="button">Refresh All Picks Dates</button>
                {% set state = runtime.get("picks_refresh") %}
                <p class="meta" data-job-status="picks_refresh" {% if not (state and (state.running or state.last_error)) %}hidden{% endif %}>
                    {% if state %}
                        {% if state.running %}
                            {{ state.last_message or "Running…" }}
                        {% elif state.last_error %}
                            Error: {{ state.last_error }}
                        {% endif %}
                    {% endif %}
                </p>
                <ul class="pipeline-log" data-job-log="picks_refresh" {% if not state or not state.running %}hidden{% endif %}>
                    {% if state and state.log %}
                        {% for entry in state.log[:5] %}
                            <li><span>{{ entry.timestamp }}</span> — {{ entry.message }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </article>

        <article class="info-card">
            <h3>Latest job runs</h3>
            <ul class="job-list" data-job-latest>
                {% for name, job in job_state.items() %}
                    <li data-job-latest-item="{{ name }}">
                        <strong>{{ job_labels.get(name, name) }}</strong>
                        <div>
                            <span data-job-latest-ran="{{ name }}">{{ (job and job.ran_at) or "never" }}</span>
                            — exit <span data-job-latest-exit="{{ name }}">{{ (job and job.exit_code) or "-" }}</span>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </article>
    </section>
</main>
<script src="/static/settings.js" defer></script>
</body>
</html>
